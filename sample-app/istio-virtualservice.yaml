---
# VirtualService for all API routes and Frontend
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: simple-buy-routes
  namespace: simple-buy
spec:
  hosts:
    - "*"
  gateways:
    - simple-buy-gateway
  http:
    # Auth Service Routes
    - match:
        - uri:
            prefix: /api/auth/
      route:
        - destination:
            host: auth.simple-buy.svc.cluster.local
            port:
              number: 8081

      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: 5xx,reset,connect-failure,refused-stream

    # Product Service Routes
    - match:
        - uri:
            prefix: /api/products
      route:
        - destination:
            host: product.simple-buy.svc.cluster.local
            port:
              number: 8082

      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: 5xx,reset,connect-failure,refused-stream

    - match:
        - uri:
            prefix: /api/categories
      route:
        - destination:
            host: product.simple-buy.svc.cluster.local
            port:
              number: 8082

      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: 5xx,reset,connect-failure,refused-stream

    # Cart Service Routes
    - match:
        - uri:
            prefix: /api/cart
      route:
        - destination:
            host: cart.simple-buy.svc.cluster.local
            port:
              number: 8083

      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: 5xx,reset,connect-failure,refused-stream

    # Order Service Routes
    - match:
        - uri:
            prefix: /api/orders
      route:
        - destination:
            host: order.simple-buy.svc.cluster.local
            port:
              number: 8084

      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: 5xx,reset,connect-failure,refused-stream

    # Notification Service Routes (SSE)
    - match:
        - uri:
            prefix: /api/notifications
      route:
        - destination:
            host: notification.simple-buy.svc.cluster.local
            port:
              number: 8085

    # Frontend - Default Route (catch-all)
    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: frontend.simple-buy.svc.cluster.local
            port:
              number: 3000

